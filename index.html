<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firefly III - Monthly Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg-primary: #f0f2f5;
            --bg-card: #ffffff;
            --bg-card-hover: #fafbfc;
            --bg-sidebar: #1a1a2e;
            --bg-input: #f5f6f8;
            --bg-input-focus: #ffffff;
            --text-primary: #1a1a2e;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --text-inverse: #ffffff;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --accent-bg: rgba(99, 102, 241, 0.08);
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --border: #e5e7eb;
            --border-light: #f3f4f6;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.08);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --transition: 0.2s ease;
        }

        html.dark {
            --bg-primary: #0f1117;
            --bg-card: #1a1d28;
            --bg-card-hover: #22252f;
            --bg-input: #22252f;
            --bg-input-focus: #2a2d3a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-bg: rgba(99, 102, 241, 0.15);
            --success-bg: rgba(16, 185, 129, 0.15);
            --danger-bg: rgba(239, 68, 68, 0.15);
            --warning-bg: rgba(245, 158, 11, 0.15);
            --border: #2a2d3a;
            --border-light: #22252f;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.3);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.4);
            --shadow-xl: 0 20px 60px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background var(--transition), color var(--transition);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6366f1, #a78bfa);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: 700;
        }

        .header-title {
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .header-subtitle {
            color: rgba(255,255,255,0.5);
            font-size: 12px;
            font-weight: 400;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-icon {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all var(--transition);
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.12);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .btn-icon.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        /* Main layout */
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Status bar */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px rgba(16,185,129,0.4); }
        .status-dot.error { background: var(--danger); box-shadow: 0 0 8px rgba(239,68,68,0.4); }
        .status-dot.loading { background: var(--warning); animation: pulse 1.5s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .month-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .month-selector select {
            padding: 8px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            appearance: none;
            padding-right: 30px;
            background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236b7280' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .month-selector select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-bg);
        }

        .btn {
            padding: 8px 20px;
            border-radius: var(--radius-sm);
            border: none;
            font-family: inherit;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #818cf8);
            color: white;
            box-shadow: 0 2px 8px rgba(99,102,241,0.3);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(99,102,241,0.4);
        }

        .btn-primary:active { transform: translateY(0); }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent);
        }

        /* Welcome / Setup Card */
        .setup-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            border: 1px solid var(--border);
            padding: 48px;
            text-align: center;
            max-width: 560px;
            margin: 80px auto;
            box-shadow: var(--shadow-lg);
        }

        .setup-card .setup-icon {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, #6366f1, #a78bfa);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            margin: 0 auto 24px;
            color: white;
        }

        .setup-card h2 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }

        .setup-card p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 32px;
            line-height: 1.7;
        }

        .form-group {
            text-align: left;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .form-group .hint {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 14px;
            transition: all var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-input-focus);
            box-shadow: 0 0 0 3px var(--accent-bg);
        }

        .form-input::placeholder { color: var(--text-muted); }

        .security-notice {
            background: var(--warning-bg);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-top: 24px;
            text-align: left;
        }

        .security-notice .notice-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .security-notice p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 0;
            line-height: 1.6;
        }

        .cors-notice {
            background: var(--accent-bg);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            margin-top: 12px;
            text-align: left;
        }

        .cors-notice .notice-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .cors-notice p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 0;
            line-height: 1.6;
        }

        .cors-notice code {
            background: rgba(99, 102, 241, 0.1);
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 11px;
            font-family: 'SF Mono', 'Fira Code', monospace;
        }

        /* Summary Cards Grid */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            padding: 24px;
            transition: all var(--transition);
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .summary-card.spent::before { background: linear-gradient(90deg, #ef4444, #f87171); }
        .summary-card.earned::before { background: linear-gradient(90deg, #10b981, #34d399); }
        .summary-card.balance::before { background: linear-gradient(90deg, #6366f1, #818cf8); }
        .summary-card.networth::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }

        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .summary-card .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-bottom: 16px;
        }

        .summary-card.spent .card-icon { background: var(--danger-bg); color: var(--danger); }
        .summary-card.earned .card-icon { background: var(--success-bg); color: var(--success); }
        .summary-card.balance .card-icon { background: var(--accent-bg); color: var(--accent); }
        .summary-card.networth .card-icon { background: var(--warning-bg); color: var(--warning); }

        .summary-card .card-label {
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .summary-card .card-value {
            font-size: 26px;
            font-weight: 700;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .summary-card .card-sub {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .summary-card .card-sub span {
            font-weight: 600;
        }

        /* Section headers */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            margin-top: 8px;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .section-header .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            background: var(--accent-bg);
            color: var(--accent);
        }

        /* Two column layout */
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .two-col { grid-template-columns: 1fr; }
        }

        /* Data tables */
        .data-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .data-card .card-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .data-card .card-header h3 {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.2px;
        }

        .data-card .card-header .count {
            font-size: 12px;
            color: var(--text-muted);
            background: var(--bg-input);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .category-list {
            padding: 0;
        }

        .category-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            border-bottom: 1px solid var(--border-light);
            transition: background var(--transition);
            gap: 16px;
        }

        .category-item:last-child { border-bottom: none; }

        .category-item:hover { background: var(--bg-card-hover); }

        .category-item .rank {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            flex-shrink: 0;
        }

        .category-item .cat-info {
            flex: 1;
            min-width: 0;
        }

        .category-item .cat-name {
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .category-item .cat-bar-wrap {
            height: 4px;
            background: var(--bg-input);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .category-item .cat-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.8s ease;
        }

        .category-item .cat-bar.expense { background: linear-gradient(90deg, #ef4444, #f87171); }
        .category-item .cat-bar.income { background: linear-gradient(90deg, #10b981, #34d399); }

        .category-item .cat-amount {
            font-size: 14px;
            font-weight: 600;
            text-align: right;
            flex-shrink: 0;
            min-width: 100px;
        }

        .cat-amount.negative { color: var(--danger); }
        .cat-amount.positive { color: var(--success); }

        /* Budget items */
        .budget-item {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-light);
            transition: background var(--transition);
        }

        .budget-item:last-child { border-bottom: none; }
        .budget-item:hover { background: var(--bg-card-hover); }

        .budget-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .budget-name {
            font-size: 14px;
            font-weight: 500;
        }

        .budget-amounts {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .budget-amounts .spent-val { font-weight: 600; color: var(--danger); }

        .budget-bar-wrap {
            height: 8px;
            background: var(--bg-input);
            border-radius: 4px;
            overflow: hidden;
        }

        .budget-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .budget-bar.ok { background: linear-gradient(90deg, #10b981, #34d399); }
        .budget-bar.warn { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .budget-bar.over { background: linear-gradient(90deg, #ef4444, #f87171); }

        .budget-footer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .budget-footer-row .remaining.over { color: var(--danger); font-weight: 600; }
        .budget-footer-row .remaining.ok { color: var(--success); }

        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-input) 25%, var(--border-light) 50%, var(--bg-input) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            height: 140px;
            border-radius: var(--radius-lg);
        }

        .skeleton-row {
            height: 52px;
            margin-bottom: 2px;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 76px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease;
            max-width: 360px;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--accent); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* Settings drawer */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(4px);
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .drawer-overlay.open { opacity: 1; visibility: visible; }

        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: 420px;
            max-width: 100vw;
            background: var(--bg-card);
            z-index: 201;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-xl);
        }

        .drawer.open { transform: translateX(0); }

        .drawer-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .drawer-header h3 {
            font-size: 16px;
            font-weight: 700;
        }

        .drawer-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-input);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all var(--transition);
        }

        .drawer-close:hover { background: var(--danger-bg); color: var(--danger); }

        .drawer-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .drawer-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .drawer-footer .btn { flex: 1; justify-content: center; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state .empty-icon {
            font-size: 40px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-state p { font-size: 14px; }

        /* Password toggle */
        .input-wrapper {
            position: relative;
        }

        .input-wrapper .toggle-vis {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .input-wrapper .toggle-vis:hover { color: var(--text-primary); }

        .input-wrapper .form-input { padding-right: 36px; }

        /* Responsive */
        @media (max-width: 640px) {
            .header { padding: 0 16px; }
            .main-content { padding: 16px; }
            .setup-card { padding: 32px 24px; margin: 40px 16px; }
            .summary-grid { grid-template-columns: 1fr 1fr; }
            .summary-card .card-value { font-size: 20px; }
            .category-item { padding: 12px 16px; }
            .budget-item { padding: 14px 16px; }
        }

        /* Fade-in animation */
        .fade-in {
            animation: fadeIn 0.4s ease forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stagger-1 { animation-delay: 0.05s; opacity: 0; }
        .stagger-2 { animation-delay: 0.1s; opacity: 0; }
        .stagger-3 { animation-delay: 0.15s; opacity: 0; }
        .stagger-4 { animation-delay: 0.2s; opacity: 0; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* YTD Row */
        .ytd-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            padding: 16px 24px;
            background: var(--bg-input);
            border-radius: var(--radius-md);
            margin-bottom: 24px;
        }

        .ytd-item .ytd-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 2px;
        }

        .ytd-item .ytd-value {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        /* Data table full width */
        .full-width-card {
            margin-bottom: 24px;
        }

        .data-scroll {
            max-height: 500px;
            overflow-y: auto;
        }

        /* Refresh spin */
        .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">F</div>
            <div>
                <div class="header-title">Firefly III Report</div>
                <div class="header-subtitle">Monthly Financial Summary</div>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn-icon" id="themeToggle" title="Toggle theme">
                <span id="themeIcon">&#9790;</span>
            </button>
            <button class="btn-icon" id="refreshBtn" title="Refresh data">&#8635;</button>
            <button class="btn-icon" id="settingsBtn" title="Settings">&#9881;</button>
        </div>
    </header>

    <!-- Toast container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Settings Drawer -->
    <div class="drawer-overlay" id="drawerOverlay"></div>
    <aside class="drawer" id="settingsDrawer">
        <div class="drawer-header">
            <h3>Settings</h3>
            <button class="drawer-close" id="drawerClose">&times;</button>
        </div>
        <div class="drawer-body">
            <div class="form-group">
                <label>Firefly III URL</label>
                <input type="url" class="form-input" id="settingsUrl" placeholder="https://firefly.example.com">
                <div class="hint">The base URL of your Firefly III instance</div>
            </div>
            <div class="form-group">
                <label>Personal Access Token</label>
                <div class="input-wrapper">
                    <input type="password" class="form-input" id="settingsKey" placeholder="eyJ0eXAiOiJKV1Q...">
                    <button class="toggle-vis" id="toggleKeyVis">&#128065;</button>
                </div>
                <div class="hint">Create one at your Firefly III &rarr; Options &rarr; Profile &rarr; OAuth</div>
            </div>
            <div class="form-group">
                <label>Currency Symbol</label>
                <input type="text" class="form-input" id="settingsCurrency" placeholder="$" maxlength="5" style="width: 80px;">
                <div class="hint">Optional override (auto-detected if blank)</div>
            </div>

            <div class="security-notice">
                <div class="notice-title">&#9888; How your data is handled</div>
                <p>Your URL and token are saved <strong>only in this browser's local storage</strong> and are never stored on our server. API requests are routed through a secure server-side proxy that forwards them to your Firefly III instance without logging or storing data. Use a <strong>read-only token</strong> for extra safety. Clear your data when using shared computers.</p>
            </div>

            <div class="cors-notice">
                <div class="notice-title">&#9432; How it works</div>
                <p>Your browser sends requests to this site's built-in proxy, which securely forwards them to your Firefly III server. This avoids browser cross-origin restrictions without requiring any configuration on your Firefly III instance. Your Firefly III URL must be accessible over <strong>HTTPS</strong>.</p>
            </div>
        </div>
        <div class="drawer-footer">
            <button class="btn btn-secondary" id="clearDataBtn">Clear Data</button>
            <button class="btn btn-primary" id="saveSettingsBtn">Save &amp; Connect</button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content" id="mainContent">
        <!-- Will be rendered by JS -->
    </main>

    <script>
    (() => {
        'use strict';

        // ===================== STATE =====================
        const state = {
            url: localStorage.getItem('ff3_url') || '',
            token: localStorage.getItem('ff3_token') || '',
            currency: localStorage.getItem('ff3_currency') || '',
            connected: false,
            loading: false,
            month: null,
            year: null,
            data: null,
        };

        // ===================== HELPERS =====================
        function getDateRange(month, year) {
            const start = new Date(year, month, 1);
            const end = new Date(year, month + 1, 0);
            return {
                start: fmt(start),
                end: fmt(end),
            };
        }

        function getYTDRange(month, year) {
            const start = new Date(year, 0, 1);
            const end = new Date(year, month + 1, 0);
            return { start: fmt(start), end: fmt(end) };
        }

        function fmt(d) {
            return d.toISOString().split('T')[0];
        }

        function formatCurrency(value, symbol) {
            const num = parseFloat(value) || 0;
            const s = symbol || state.detectedCurrency || '$';
            const abs = Math.abs(num);
            const formatted = abs.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            return (num < 0 ? '-' : '') + s + formatted;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // ===================== TOAST =====================
        function toast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const el = document.createElement('div');
            el.className = `toast ${type}`;
            const icons = { success: '\u2713', error: '\u2717', info: '\u24D8' };
            el.innerHTML = `<span>${icons[type] || ''}</span><span>${escapeHtml(message)}</span>`;
            container.appendChild(el);
            setTimeout(() => {
                el.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(() => el.remove(), 300);
            }, 4000);
        }

        // ===================== THEME =====================
        function initTheme() {
            const saved = localStorage.getItem('ff3_theme');
            if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
            updateThemeIcon();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            localStorage.setItem('ff3_theme', isDark ? 'dark' : 'light');
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('themeIcon').innerHTML = isDark ? '&#9788;' : '&#9790;';
        }

        // ===================== DRAWER =====================
        function openDrawer() {
            document.getElementById('settingsUrl').value = state.url;
            document.getElementById('settingsKey').value = state.token;
            document.getElementById('settingsCurrency').value = state.currency;
            document.getElementById('drawerOverlay').classList.add('open');
            document.getElementById('settingsDrawer').classList.add('open');
        }

        function closeDrawer() {
            document.getElementById('drawerOverlay').classList.remove('open');
            document.getElementById('settingsDrawer').classList.remove('open');
        }

        function saveSettings() {
            let url = document.getElementById('settingsUrl').value.trim();
            const token = document.getElementById('settingsKey').value.trim();
            const currency = document.getElementById('settingsCurrency').value.trim();

            if (!url || !token) {
                toast('Please fill in both URL and token', 'error');
                return;
            }

            // Remove trailing slash
            url = url.replace(/\/+$/, '');

            state.url = url;
            state.token = token;
            state.currency = currency;
            localStorage.setItem('ff3_url', url);
            localStorage.setItem('ff3_token', token);
            localStorage.setItem('ff3_currency', currency);

            closeDrawer();
            toast('Settings saved', 'success');
            testAndLoad();
        }

        function clearData() {
            localStorage.removeItem('ff3_url');
            localStorage.removeItem('ff3_token');
            localStorage.removeItem('ff3_currency');
            state.url = '';
            state.token = '';
            state.currency = '';
            state.connected = false;
            state.data = null;
            closeDrawer();
            toast('All stored data cleared', 'info');
            render();
        }

        // ===================== API =====================
        async function api(endpoint, params = {}) {
            // Built-in proxy: requests go to /proxy/<endpoint> on the same origin,
            // with X-Target-Base telling the Worker where to forward.
            // This avoids all CORS issues when hosted on Cloudflare Pages.
            const proxyPath = '/proxy' + endpoint;
            const fetchUrl = new URL(proxyPath, window.location.origin);
            Object.entries(params).forEach(([k, v]) => fetchUrl.searchParams.set(k, v));

            const resp = await fetch(fetchUrl.toString(), {
                headers: {
                    'Authorization': `Bearer ${state.token}`,
                    'Accept': 'application/json',
                    'X-Target-Base': state.url,
                },
            });
            if (!resp.ok) {
                throw new Error(`API error ${resp.status}: ${resp.statusText}`);
            }
            return resp.json();
        }

        async function testConnection() {
            try {
                await api('/api/v1/about');
                return true;
            } catch (e) {
                return false;
            }
        }

        async function fetchAllPages(endpoint, params = {}) {
            let page = 1;
            let allData = [];
            while (true) {
                const result = await api(endpoint, { ...params, page: String(page) });
                allData = allData.concat(result.data || []);
                const totalPages = result.meta?.pagination?.total_pages || 1;
                if (page >= totalPages) break;
                page++;
            }
            return allData;
        }

        async function fetchReport(month, year) {
            const { start, end } = getDateRange(month, year);
            const { start: ytdStart, end: ytdEnd } = getYTDRange(month, year);

            // Fetch in parallel: summary (monthly + YTD), categories, budgets
            const [summaryMonthly, summaryYTD, categories, budgets] = await Promise.all([
                api('/api/v1/summary/basic', { start, end }),
                api('/api/v1/summary/basic', { start: ytdStart, end: ytdEnd }),
                fetchAllPages('/api/v1/categories'),
                fetchAllPages('/api/v1/budgets'),
            ]);

            // Detect currency from summary keys
            let detectedCurrencyCode = '';
            let detectedCurrencySymbol = '';
            for (const key of Object.keys(summaryMonthly)) {
                const match = key.match(/^spent-in-(.+)$/);
                if (match) {
                    detectedCurrencyCode = match[1];
                    if (summaryMonthly[key]?.currency_symbol) {
                        detectedCurrencySymbol = summaryMonthly[key].currency_symbol;
                    }
                    break;
                }
            }

            state.detectedCurrency = state.currency || detectedCurrencySymbol || detectedCurrencyCode || '$';

            // Parse summary
            const monthly = parseSummary(summaryMonthly, detectedCurrencyCode);
            const ytd = parseSummary(summaryYTD, detectedCurrencyCode);

            // Fetch category details with spent/earned
            const categoryDetails = await Promise.all(
                categories.map(cat =>
                    api(`/api/v1/categories/${cat.id}`, { start, end })
                        .then(r => r.data)
                        .catch(() => null)
                )
            );

            const categoryData = categoryDetails
                .filter(Boolean)
                .map(cat => {
                    const attrs = cat.attributes || {};
                    const spent = parseFloat(attrs.spent?.[0]?.sum || '0');
                    const earned = parseFloat(attrs.earned?.[0]?.sum || '0');
                    const total = earned + spent; // spent is negative
                    return {
                        name: attrs.name || 'Unknown',
                        spent,
                        earned,
                        total,
                    };
                })
                .sort((a, b) => {
                    const aAbs = Math.abs(a.total);
                    const bAbs = Math.abs(b.total);
                    if (aAbs === 0 && bAbs === 0) return 0;
                    if (aAbs === 0) return 1;
                    if (bAbs === 0) return -1;
                    return bAbs - aAbs;
                });

            // Fetch budget details
            const budgetDetails = await Promise.all(
                budgets.map(async (b) => {
                    try {
                        const detail = await api(`/api/v1/budgets/${b.id}`, { start, end });
                        const attrs = detail.data?.attributes || {};
                        let limit = parseFloat(attrs.auto_budget_amount || '0');

                        if (!limit) {
                            try {
                                const limits = await api(`/api/v1/budgets/${b.id}/limits`, { start, end });
                                const limArr = limits.data || [];
                                if (limArr.length > 0) {
                                    limit = parseFloat(limArr[0].attributes?.amount || '0');
                                }
                            } catch (e) { /* no limits */ }
                        }

                        const spent = parseFloat(attrs.spent?.[0]?.sum || '0');
                        const remaining = limit + spent; // spent is negative
                        return {
                            name: attrs.name || 'Unknown',
                            limit,
                            spent: Math.abs(spent),
                            remaining,
                            pct: limit > 0 ? Math.min((Math.abs(spent) / limit) * 100, 100) : 0,
                            overBudget: remaining < 0,
                        };
                    } catch (e) {
                        return null;
                    }
                })
            );

            const budgetData = budgetDetails
                .filter(b => b && (b.limit > 0 || b.spent > 0))
                .sort((a, b) => b.spent - a.spent);

            return { monthly, ytd, categories: categoryData, budgets: budgetData };
        }

        function parseSummary(summary, currencyCode) {
            const get = (prefix) => {
                const key = `${prefix}-in-${currencyCode}`;
                return parseFloat(summary[key]?.monetary_value || '0');
            };
            return {
                spent: get('spent'),
                earned: get('earned'),
                balance: get('balance'),
                netWorth: get('net-worth'),
            };
        }

        // ===================== LOAD DATA =====================
        async function testAndLoad() {
            if (!state.url || !state.token) {
                render();
                return;
            }

            state.loading = true;
            state.connected = false;
            render();

            const ok = await testConnection();
            if (!ok) {
                state.loading = false;
                state.connected = false;
                render();
                toast('Failed to connect. Check your URL and token.', 'error');
                return;
            }

            state.connected = true;
            toast('Connected to Firefly III', 'success');

            try {
                state.data = await fetchReport(state.month, state.year);
            } catch (e) {
                toast('Error fetching report: ' + e.message, 'error');
                console.error(e);
            }

            state.loading = false;
            render();
        }

        // ===================== RENDER =====================
        function render() {
            const main = document.getElementById('mainContent');

            // If not configured, show setup card
            if (!state.url || !state.token) {
                main.innerHTML = renderSetupCard();
                bindSetupEvents();
                return;
            }

            // If loading
            if (state.loading) {
                main.innerHTML = renderStatusBar() + renderLoadingSkeleton();
                bindStatusEvents();
                return;
            }

            // If not connected
            if (!state.connected || !state.data) {
                main.innerHTML = renderStatusBar() + `
                    <div class="setup-card" style="margin-top:60px">
                        <div class="setup-icon" style="background:linear-gradient(135deg,#ef4444,#f87171)">&#9888;</div>
                        <h2>Connection Failed</h2>
                        <p>Could not reach your Firefly III instance. Please verify that your URL is correct, uses HTTPS, and that your personal access token is valid.</p>
                        <button class="btn btn-primary" onclick="document.getElementById('settingsBtn').click()">Open Settings</button>
                    </div>
                `;
                bindStatusEvents();
                return;
            }

            // Render dashboard
            main.innerHTML = renderStatusBar() + renderDashboard();
            bindStatusEvents();
        }

        function renderSetupCard() {
            return `
                <div class="setup-card fade-in">
                    <div class="setup-icon">F</div>
                    <h2>Welcome to Firefly III Report</h2>
                    <p>Connect to your Firefly III instance to view your monthly financial summary. Enter your server URL and personal access token to get started.</p>
                    <div class="form-group">
                        <label>Firefly III URL</label>
                        <input type="url" class="form-input" id="setupUrl" placeholder="https://firefly.example.com">
                    </div>
                    <div class="form-group">
                        <label>Personal Access Token</label>
                        <div class="input-wrapper">
                            <input type="password" class="form-input" id="setupKey" placeholder="eyJ0eXAiOiJKV1Q...">
                            <button class="toggle-vis" id="toggleSetupVis">&#128065;</button>
                        </div>
                        <div class="hint">Create at Firefly III &rarr; Options &rarr; Profile &rarr; OAuth</div>
                    </div>
                    <button class="btn btn-primary" id="setupConnectBtn" style="width:100%;justify-content:center;padding:12px 24px;font-size:14px;margin-top:8px;">
                        Connect
                    </button>
                    <div class="security-notice">
                        <div class="notice-title">&#9888; How your data is handled</div>
                        <p>Your URL and token are saved <strong>only in this browser's local storage</strong>. They are never stored on our server. API requests are routed through a secure server-side proxy to avoid browser restrictions &mdash; the proxy forwards your request to your Firefly III instance and does not log or store any data. Use a <strong>read-only token</strong> for extra safety, and always clear your data on shared computers.</p>
                    </div>
                </div>
            `;
        }

        function bindSetupEvents() {
            const connectBtn = document.getElementById('setupConnectBtn');
            if (connectBtn) {
                connectBtn.addEventListener('click', () => {
                    let url = document.getElementById('setupUrl').value.trim().replace(/\/+$/, '');
                    const token = document.getElementById('setupKey').value.trim();
                    if (!url || !token) {
                        toast('Please fill in both fields', 'error');
                        return;
                    }
                    state.url = url;
                    state.token = token;
                    localStorage.setItem('ff3_url', url);
                    localStorage.setItem('ff3_token', token);
                    toast('Settings saved', 'success');
                    testAndLoad();
                });
            }
            const toggleVis = document.getElementById('toggleSetupVis');
            if (toggleVis) {
                toggleVis.addEventListener('click', () => {
                    const inp = document.getElementById('setupKey');
                    inp.type = inp.type === 'password' ? 'text' : 'password';
                });
            }
        }

        function renderStatusBar() {
            const statusClass = state.loading ? 'loading' : (state.connected ? 'connected' : 'error');
            const statusText = state.loading ? 'Connecting...' : (state.connected ? 'Connected' : 'Disconnected');
            const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];

            let monthOptions = '';
            for (let m = 0; m < 12; m++) {
                const sel = m === state.month ? ' selected' : '';
                monthOptions += `<option value="${m}"${sel}>${monthNames[m]}</option>`;
            }

            let yearOptions = '';
            const curYear = new Date().getFullYear();
            for (let y = curYear; y >= curYear - 5; y--) {
                const sel = y === state.year ? ' selected' : '';
                yearOptions += `<option value="${y}"${sel}>${y}</option>`;
            }

            return `
                <div class="status-bar fade-in">
                    <div class="status-indicator">
                        <span class="status-dot ${statusClass}"></span>
                        ${statusText}
                    </div>
                    <div class="month-selector">
                        <select id="monthSelect">${monthOptions}</select>
                        <select id="yearSelect">${yearOptions}</select>
                        <button class="btn btn-primary" id="loadBtn" ${state.loading ? 'disabled' : ''}>
                            ${state.loading ? '<span class="spin">&#8635;</span> Loading...' : 'Load Report'}
                        </button>
                    </div>
                </div>
            `;
        }

        function bindStatusEvents() {
            const loadBtn = document.getElementById('loadBtn');
            if (loadBtn) {
                loadBtn.addEventListener('click', () => {
                    state.month = parseInt(document.getElementById('monthSelect').value);
                    state.year = parseInt(document.getElementById('yearSelect').value);
                    testAndLoad();
                });
            }
        }

        function renderLoadingSkeleton() {
            return `
                <div class="summary-grid fade-in">
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                    <div class="skeleton skeleton-card"></div>
                </div>
                <div class="two-col fade-in">
                    <div>
                        ${Array(5).fill('<div class="skeleton skeleton-row"></div>').join('')}
                    </div>
                    <div>
                        ${Array(5).fill('<div class="skeleton skeleton-row"></div>').join('')}
                    </div>
                </div>
            `;
        }

        function renderDashboard() {
            const d = state.data;
            const sym = state.detectedCurrency || '$';

            // Monthly summary cards
            let html = `
                <div class="summary-grid">
                    <div class="summary-card spent fade-in stagger-1">
                        <div class="card-icon">&darr;</div>
                        <div class="card-label">Monthly Spent</div>
                        <div class="card-value" style="color:var(--danger)">${formatCurrency(d.monthly.spent, sym)}</div>
                        <div class="card-sub">YTD: <span style="color:var(--danger)">${formatCurrency(d.ytd.spent, sym)}</span></div>
                    </div>
                    <div class="summary-card earned fade-in stagger-2">
                        <div class="card-icon">&uarr;</div>
                        <div class="card-label">Monthly Earned</div>
                        <div class="card-value" style="color:var(--success)">${formatCurrency(d.monthly.earned, sym)}</div>
                        <div class="card-sub">YTD: <span style="color:var(--success)">${formatCurrency(d.ytd.earned, sym)}</span></div>
                    </div>
                    <div class="summary-card balance fade-in stagger-3">
                        <div class="card-icon">&Delta;</div>
                        <div class="card-label">Net Change</div>
                        <div class="card-value" style="color:${d.monthly.balance >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(d.monthly.balance, sym)}</div>
                        <div class="card-sub">YTD: <span style="color:${d.ytd.balance >= 0 ? 'var(--success)' : 'var(--danger)'}">${formatCurrency(d.ytd.balance, sym)}</span></div>
                    </div>
                    <div class="summary-card networth fade-in stagger-4">
                        <div class="card-icon">&#9733;</div>
                        <div class="card-label">Net Worth</div>
                        <div class="card-value">${formatCurrency(d.ytd.netWorth, sym)}</div>
                        <div class="card-sub">As of report period end</div>
                    </div>
                </div>
            `;

            // Two columns: categories + budgets
            html += '<div class="two-col">';

            // Categories
            const maxCatAbs = d.categories.length > 0 ? Math.max(...d.categories.map(c => Math.abs(c.total))) : 1;
            html += `
                <div class="data-card fade-in stagger-2">
                    <div class="card-header">
                        <h3>Category Breakdown</h3>
                        <span class="count">${d.categories.length} categories</span>
                    </div>
                    <div class="category-list data-scroll">
            `;

            if (d.categories.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">&#128202;</div><p>No category data for this period</p></div>`;
            } else {
                d.categories.forEach((cat, i) => {
                    const barWidth = maxCatAbs > 0 ? (Math.abs(cat.total) / maxCatAbs) * 100 : 0;
                    const barClass = cat.total >= 0 ? 'income' : 'expense';
                    const amtClass = cat.total >= 0 ? 'positive' : 'negative';
                    html += `
                        <div class="category-item">
                            <span class="rank">${i + 1}</span>
                            <div class="cat-info">
                                <div class="cat-name">${escapeHtml(cat.name)}</div>
                                <div class="cat-bar-wrap">
                                    <div class="cat-bar ${barClass}" style="width:${barWidth}%"></div>
                                </div>
                            </div>
                            <span class="cat-amount ${amtClass}">${formatCurrency(cat.total, sym)}</span>
                        </div>
                    `;
                });
            }

            html += '</div></div>';

            // Budgets
            html += `
                <div class="data-card fade-in stagger-3">
                    <div class="card-header">
                        <h3>Budget Tracking</h3>
                        <span class="count">${d.budgets.length} budgets</span>
                    </div>
                    <div class="data-scroll">
            `;

            if (d.budgets.length === 0) {
                html += `<div class="empty-state"><div class="empty-icon">&#128176;</div><p>No budget data for this period</p></div>`;
            } else {
                d.budgets.forEach(b => {
                    const pctDisplay = b.limit > 0 ? Math.round((b.spent / b.limit) * 100) : 0;
                    let barClass = 'ok';
                    if (pctDisplay >= 90) barClass = 'over';
                    else if (pctDisplay >= 70) barClass = 'warn';

                    const remainClass = b.overBudget ? 'over' : 'ok';
                    const remainText = b.overBudget
                        ? `Over by ${formatCurrency(Math.abs(b.remaining), sym)}`
                        : `${formatCurrency(b.remaining, sym)} remaining`;

                    html += `
                        <div class="budget-item">
                            <div class="budget-header-row">
                                <span class="budget-name">${escapeHtml(b.name)}</span>
                                <span class="budget-amounts">
                                    <span class="spent-val">${formatCurrency(-b.spent, sym)}</span>
                                    ${b.limit > 0 ? ` / ${formatCurrency(b.limit, sym)}` : ''}
                                </span>
                            </div>
                            ${b.limit > 0 ? `
                            <div class="budget-bar-wrap">
                                <div class="budget-bar ${barClass}" style="width:${Math.min(pctDisplay, 100)}%"></div>
                            </div>
                            <div class="budget-footer-row">
                                <span class="remaining ${remainClass}">${remainText}</span>
                                <span>${pctDisplay}%</span>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            html += '</div></div>';
            html += '</div>'; // close two-col

            return html;
        }

        // ===================== INIT =====================
        function init() {
            initTheme();

            // Set default month to previous month
            const now = new Date();
            const prev = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            state.month = prev.getMonth();
            state.year = prev.getFullYear();

            // Bind header events
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('settingsBtn').addEventListener('click', openDrawer);
            document.getElementById('drawerOverlay').addEventListener('click', closeDrawer);
            document.getElementById('drawerClose').addEventListener('click', closeDrawer);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('clearDataBtn').addEventListener('click', clearData);
            document.getElementById('refreshBtn').addEventListener('click', () => testAndLoad());

            document.getElementById('toggleKeyVis').addEventListener('click', () => {
                const inp = document.getElementById('settingsKey');
                inp.type = inp.type === 'password' ? 'text' : 'password';
            });

            // Keyboard shortcut: Escape to close drawer
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeDrawer();
            });

            // Initial render
            if (state.url && state.token) {
                testAndLoad();
            } else {
                render();
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
